name: Build iOS for Sideloading

on:
  workflow_dispatch: # Allows you to manually trigger the build

jobs:
  build:
    name: Build IPA
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - name: Install Dependencies
        run: flutter pub get

      # 1. Build for Real Device (ARM64)
      # --release: Targets real iPhone chips (Fixes "Verification Failed" error)
      # --no-codesign: Builds without needing a paid Apple account
      - name: Build iOS App
        run: flutter build ios --release --no-codesign

      # 2. Fix IPA Structure
      # Sideloadly CRASHES if the app isn't inside a folder named 'Payload'
      - name: Prepare IPA Structure
        run: |
          mkdir -p Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r app.ipa Payload

      # 3. Upload the IPA for you to download
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Sideload-Ready-IPA
          path: app.ipa
          retention-days: 1
